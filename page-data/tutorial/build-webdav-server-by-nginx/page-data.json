{"componentChunkName":"component---node-modules-suziwen-gatsby-theme-sculpting-src-templates-template-blog-post-js","path":"/tutorial/build-webdav-server-by-nginx","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://suziwen.github.io/acorns"}},"storyWriterMarkdown":{"id":"1b163ebc-62b2-5fab-8a9c-5d35cf986718","html":"\n\n\t<div class=\"preview html_preview xsj_export_zip\"><div style=\"overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; display: none;\"><svg style=\"display: none;\"><defs id=\"MathJax_SVG_glyphs\"/><defs xmlns=\"http://www.w3.org/2000/svg\"><filter xmlns=\"http://www.w3.org/2000/svg\" id=\"dropshadow\" height=\"130%\">      <fegaussianblur in=\"SourceAlpha\" stddeviation=\"3\"/>       <feoffset dx=\"2\" dy=\"2\" result=\"offsetblur\"/>       <femerge>         <femergenode/>        <femergenode in=\"SourceGraphic\"/>       </femerge>    </filter><filter id=\"editing-stripe-bk\" filterunits=\"userSpaceOnUse\" x=\"-100%\" y=\"-100%\" width=\"300%\" height=\"300%\"><feflood flood-color=\"#700f0f\" result=\"flood1\"/><feflood flood-color=\"#fff\" flood-opacity=\"0.5\" result=\"flood2\"/><feimage xlink:href=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAwcHgiIGhlaWdodD0iMTAwMHB4Ij48ZGVmcz48cGF0dGVybiBpZD0icGF0dGVybiIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeD0iMCIgeT0iMCIgd2lkdGg9IjQiIGhlaWdodD0iNCI+PHBhdGggZD0iTSAtNCAtNCBMIDggOCBNIC04IC00IEwgNCA4IE0gLTQgLTggTCA4IDQiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIxIi8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI3BhdHRlcm4pIi8+PC9zdmc+\" x=\"0\" y=\"0\" width=\"2000\" height=\"1000\" result=\"image\"/><fetile in=\"image\" result=\"tile\"/><fecomposite operator=\"in\" in=\"flood1\" in2=\"tile\" result=\"tile2\"/><fegaussianblur in=\"SourceAlpha\" stddeviation=\"10\" result=\"blur\"/><fecomposite operator=\"in\" in=\"tile2\" in2=\"blur\" result=\"cloud\"/><femorphology operator=\"dilate\" radius=\"2\" in=\"SourceAlpha\" result=\"dilate\"/><fecomposite operator=\"in\" in=\"flood2\" in2=\"dilate\" result=\"base\"/><femerge><femergenode in=\"cloud\"/><femergenode in=\"base\"/><femergenode in=\"SourceGraphic\"/></femerge></filter></defs></svg></div><blockquote class=\"markdown_blockquote\">\n<p class=\"xsj_paragraph xsj_paragraph_level_1\"><span class=\"xsj_placeholder_span\"></span>本文为转载文章,如果涉及侵权,请联系 <a href=\"mailto:suziwen1@gmail.com\" class=\"xsj_link xsj_auto_link\">suziwen1@gmail.com</a>,会第一时间删除</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_1\"><span class=\"xsj_placeholder_span\"></span>转载自: <a href=\"https://www.binss.me/blog/build-webdav-server-by-nginx/\" class=\"xsj_link xsj_auto_link\">https://www.binss.me/blog/build-webdav-server-by-nginx/</a></p>\n</blockquote>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\"></p><div class=\"toc mindmap_toc mindmap_container\" data-hash=\"28a55a0f0ee61cdb34c052bde7dd51dd_mindmap_toc\"><div class=\"xsj_mindmap xsj_mindmap_toc\"><svg id=\"xsj_mindmap_toc_1588046983767\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" class=\"xsj_svg_viewbox\" style=\"max-width:889px;max-height:311px;\" viewbox=\"0 0 889 311\" width=\"100%\" height=\"100%\"><g transform=\"translate(402.5,177.5) scale(1)\"><g class=\"markmap-link\" style=\"fill:none;\"><path stroke=\"#dc3912\" stroke-width=\"4\" d=\"M166.5,-40.5 L171.5,-40.5 C243.5,-40.5 238.5,40.5 274.5,40.5 L276.5,40.5\"/><polygon class=\"markmap-link-polygon\" stroke-width=\"0\" transform=\"translate(166.5, -40.5)\" points=\"0,-3 5,0 0,3 -5,0\" style=\"fill: white;\"/><g transform=\"translate(274.5,40.5)\"><path class=\"markmap-node-path\" d=\"M0,0L121,0\" stroke-width=\"4\" stroke=\"#dc3912\"/><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(121, 0)\" points=\"0,-2 5,0 0,2 -5,0\" style=\"fill: rgb(220, 57, 18);\"/></g></g><g class=\"markmap-link\" style=\"fill:none;\"><path stroke=\"#ff9900\" stroke-width=\"4\" d=\"M166.5,-40.5 L171.5,-40.5 C243.5,-40.5 238.5,-40.5 274.5,-40.5 L276.5,-40.5\"/><polygon class=\"markmap-link-polygon\" stroke-width=\"0\" transform=\"translate(166.5, -40.5)\" points=\"0,-3 5,0 0,3 -5,0\" style=\"fill: white;\"/><g transform=\"translate(274.5,-40.5)\"><path class=\"markmap-node-path\" d=\"M0,0L163,0\" stroke-width=\"4\" stroke=\"#ff9900\"/><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(163, 0)\" points=\"0,-2 5,0 0,2 -5,0\" style=\"fill: rgb(255, 153, 0);\"/></g></g><g class=\"markmap-link\" style=\"fill:none;\"><path stroke=\"#3366cc\" stroke-width=\"4\" d=\"M166.5,-40.5 L171.5,-40.5 C243.5,-40.5 238.5,-121.5 274.5,-121.5 L276.5,-121.5\"/><polygon class=\"markmap-link-polygon\" stroke-width=\"0\" transform=\"translate(166.5, -40.5)\" points=\"0,-3 5,0 0,3 -5,0\" style=\"fill: white;\"/><g transform=\"translate(274.5,-121.5)\"><path class=\"markmap-node-path\" d=\"M0,0L150,0\" stroke-width=\"4\" stroke=\"#3366cc\"/><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(150, 0)\" points=\"0,-2 5,0 0,2 -5,0\" style=\"fill: rgb(51, 102, 204);\"/></g></g><g class=\"markmap-node markmap-root-node\" transform=\"translate(-310.5,-40.5)\"><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(476, 0)\" points=\"0,-3 5,0 0,3 -5,0\" style=\"fill: rgb(51, 102, 204);\"/><g transform=\"translate(1, -36)\"><rect class=\"markmap-node-rect\" rx=\"10\" ry=\"10\" height=\"72\" width=\"475\" fill=\"rgb(78, 156, 255)\" stroke=\"#3366cc\" stroke-width=\"1\"/><text class=\"markmap-node-text\" alignment-baseline=\"middle\" x=\"238.5\" y=\"46\" text-anchor=\"middle\" style=\"font: bolder 30px sans-serif; fill-opacity: 1; fill: rgb(255, 255, 255);\">使用 nginx 搭建 WebDAV 服务器</text></g></g><g class=\"markmap-node\" transform=\"translate(274.5,40.5)\"><a xlink:href=\"#plan20b20nginx_3\"><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 20px sans-serif; fill: rgb(220, 57, 18); stroke: white; stroke-width: 2px; cursor: pointer;\">Plan B: nginx</text><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 20px sans-serif; fill: rgb(220, 57, 18); cursor: pointer;\">Plan B: nginx</text></a></g><g class=\"markmap-node\" transform=\"translate(274.5,-40.5)\"><a xlink:href=\"#plan20a20nextcloud_2\"><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 20px sans-serif; fill: rgb(255, 153, 0); stroke: white; stroke-width: 2px; cursor: pointer;\">Plan A: nextcloud</text><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 20px sans-serif; fill: rgb(255, 153, 0); cursor: pointer;\">Plan A: nextcloud</text></a></g><g class=\"markmap-node\" transform=\"translate(274.5,-121.5)\"><a xlink:href=\"#webdav20e698afe4bb80e4b988_1\"><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 20px sans-serif; fill: rgb(51, 102, 204); stroke: white; stroke-width: 2px; cursor: pointer;\">WebDAV 是什么</text><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 20px sans-serif; fill: rgb(51, 102, 204); cursor: pointer;\">WebDAV 是什么</text></a></g><g class=\"annotation-group\"><g class=\"annotations\"/></g></g></svg></div></div><p></p>\n<h2 class=\"xsj_heading_hash xsj_heading xsj_heading_h2\" id=\"webdav20e698afe4bb80e4b988_1\"><div class=\"xiaoshujiang_element xsj_anchor\">\n  <a name=\"webdav20e698afe4bb80e4b988_1\" class=\"blank_anchor_name\"></a><a id=\"webdav20e698afe4bb80e4b988_1\" class=\"blank_anchor_id\"></a><a name=\"webdav-是什么\" class=\"blank_anchor_name\"></a><a id=\"webdav-是什么\" class=\"blank_anchor_id\"></a>\n</div>\n<span class=\"xsj_heading_content\">WebDAV 是什么</span></h2>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">根据 wikipedia ：</p>\n<blockquote class=\"markdown_blockquote\">\n<p class=\"xsj_paragraph xsj_paragraph_level_1\"><span class=\"xsj_placeholder_span\"></span>Web Distributed Authoring and Versioning (WebDAV) is an extension of the Hypertext Transfer Protocol (HTTP) that allows clients to perform remote Web content authoring operations.</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_1\"><span class=\"xsj_placeholder_span\"></span>The WebDAV protocol provides a framework for users to create, change and move documents on a server. The most important features of the WebDAV protocol include the maintenance of properties about an author or modification date, namespace management, collections, and overwrite protection. Maintenance of properties includes such things as the creation, removal, and querying of file information.</p>\n</blockquote>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">个人理解，WebDAV 就是通过 Restful API ，实现对服务端文件的 创建 / 删除 / 读取 / 修改，比起其他文件传输协议，它基于 HTTP，不容易被当作不明流量被砍掉。同时能够利用 HTTP 的各种扩展，比如 HTTPS 提供数据加密功能、HTTP 2.0 提供数据流传输、HTTP 范围请求(RFC7233)等。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">正是因为这些好处，很多系统和软件都提供了对 WebDAV 的支持。比如说 OS X 的 finder 支持远程连接到 WebDAV 服务器。IOS 的播放器 nPlayer 能够播放 WebDAV 上的视频文件，且传输速度高于 FTP / SMB 等协议。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">于是乎，我选择了 WebDAV 作为远程播放 NAS 视频流的传输协议。</p>\n<h2 class=\"xsj_heading_hash xsj_heading xsj_heading_h2\" id=\"plan20a20nextcloud_2\"><div class=\"xiaoshujiang_element xsj_anchor\">\n  <a name=\"plan20a20nextcloud_2\" class=\"blank_anchor_name\"></a><a id=\"plan20a20nextcloud_2\" class=\"blank_anchor_id\"></a><a name=\"plan-a-nextcloud\" class=\"blank_anchor_name\"></a><a id=\"plan-a-nextcloud\" class=\"blank_anchor_id\"></a>\n</div>\n<span class=\"xsj_heading_content\">Plan A: nextcloud</span></h2>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">我将下载下来的电影目录挂载到个人网盘 nextcloud 上，并在 nextcloud 中配置为外部挂载。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">我搭建 nextcloud 的架构如下：</p>\n<div class=\"xiaoshujiang_code_container\"><div class=\"xiaoshujiang_pre\"><div class=\"nohighlight hljs code_linenums xiaoshujiang_code\"><ol start=\"1\" class=\"ol_linenums\" style=\"counter-reset: lines 0;\"><li class=\"li_linenum \" date-linenum=\"1\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">1</span>nginx - nextcloud - redis<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"2\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">2</span>                  - mariadb<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li></ol></div></div></div>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">组件之间各自容器化部署，然后通过 tcp 进行连接。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">由于 nextcloud 自带 WebDAV 服务，我们可以直接连接上去：</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\"></p><div class=\"story_image_container story_block_image\"><div class=\"story_image\"><div class=\"gatsby-wrapper-image\" style=\"display:inline-block;max-width: 100%;width:224px; margin-left: auto; margin-right: auto;position:relative;\"><div style=\"width:100%;display:block;padding-bottom: 267.85714285714283%;\"></div><img class=\"background_image\" src=\"data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='400'%20height='1071'%20viewBox='0%200%20400%201071'%20preserveAspectRatio='none'%3e%3cpath%20d='M0%2032c0%2030%200%2031%202%2031s2-1%202-31C4%201%204%200%202%200S0%201%200%2032m24-15v11l1%209h24v-8c0-9%200-9-7-9l-7-2c-2-2-10-3-11-1m62%209v8l-2-5-2-5-1-2c-1-5-3-3-6%204l-3%208c0%202%203%201%204-2%200-3%205-3%206%201%201%202%202%202%204%202s3-1%203-8c0-11-3-12-3-1m33-3c-6%205-1%2016%206%2012h4c2%202%207%200%208-2%200-2-3-6-5-6l-1-1h3c2%200%202%200%202-2s-6-3-7%200l-1%201-3-1c-2-2-4-2-6-1M33%2086c-4%200-9%206-10%2011-1%2012%2014%2020%2023%2011%209-11%200-24-13-22m5%207l2%206c4%205%202%206-4%203-2-2-3-2-3-4l2-5c0-5-4-3-7%201-4%209%207%2018%2015%2011%204-3%203-12-2-15l-3-1v4m37-1v14l1-2c0-4%202-4%205%200s4%203%202-1v-5c2-2%202-3%201-5-2-2-8-3-9-1m-41%2072c-2%203-2%203-6%203-5%200-5%202-1%204%203%202%204%203%202%207-1%204%200%204%204%202h6c5%203%205%203%204-2%200-4%200-5%202-6%204-3%204-5-1-5-3%200-4-1-5-4-2-4-4-4-5%201m67%205l-1%203c0%203-3%202-3-1l-2-3c-1%200-1%204%202%208%201%204%203%203%204-1%202-5%203-6%203-3%200%204%203%207%206%207%204%200%205-2%205-6%200-6-5-8-9-4h-2c0-3-2-2-3%200m-60%2064l-2%202-9%203c-3%200-5%202-5%204%200%204%202%205%206%205%203%200%205%201%207%204%204%203%208%204%2010%201%201-4-1-6-4-6l-7-2-3-1%202-2%206-1c3-1%206-2%206-5%200-4-5-5-7-2m95%204c0%202%200%202-2%202-4-2-7%207-4%2011h8c1-1%201-15-1-15l-1%202m68%202c-5%203-3%2011%202%2012l5-1c2-2%201-8-1-10s-3-2-6-1M40%20306c-3%203-7%205-10%204-3%200-5%202-5%205%200%202%202%204%205%204%202-1%209%203%2010%205%202%203%207%203%208%200%201-4-1-6-4-6l-10-3%208-4c4%201%205%200%206-3%201-5-4-7-8-2m96%203c0%202-1%202-3%202-3%200-3%200-4%206-1%205%204%208%209%205%201-1%201-14-1-15l-1%202m57%203c-3%201-1%2010%203%2011%203%201%206-2%206-6%200-6-3-7-9-5M37%20378c-4%204-6%207-5%209%200%203%203%202%203%200%200-3%207-9%208-7v2c-1%201%200%204%201%204%204%200%204-9%200-10-2-1-4-1-7%202m100%201l-1%202c0%202-1%202-2%202-3-1-5%201-5%206%200%204%200%205%203%206%205%201%206%200%207-8%200-7-1-10-2-8m10%208l1%208h3c4%200%206-2%206-6s1-4%203%201c1%205%201%206-1%208-1%202-1%202%201%202s6-8%208-14c1-4-2-4-3%201-2%204-3%204-4-1-1-3-1-3-3-2-1%202-2%202-3%200s-2-2-4-1c-2%200-2%200-2-2l-1-2-1%208m-109-1c-1%204-7%209-8%207v-3c2-3-2-4-4-1-3%204%201%2010%206%209%203-2%2010-9%209-12%200-3-3-3-3%200m-13%2064v5l15%2015%204-4%204-4-3-4c-10-10-11-11-16-11-4%200-4%200-4%203m71%206v4l-1%206c-1%204%200%206%204%206s7-2%207-5c0-1-2-2-5-2s-3-1%200-3c2%200%203-1%203-4%200-4%200-4-3-4l-5%202m-58%2063v3c2%201%202%201-1%203l-2%204c1%203%204%203%206%201l3-2%203%201c2%200%202-10-1-10h-8m-11%203c-2%201-2%203-2%209%200%2010%201%2011%2011%2011%208%200%2010-1%2010-7-1-4-3-5-3-1v4H29v-14h4l3-1c-1-2-7-2-9-1m151%205c-7%201-6%2012%201%2012%204%200%207-8%203-11l-2-2-2%201m29%201l-1%205-1%206c-2%204%201%205%209%204l1-2c1-3-1-5-3-5h-3l2-2%203-2c1-4%200-5-3-5l-4%201M1%20745l-1%2036c0%2035%200%2036%202%2036s2-1%202-36a453%20453%200%2000-3-36m32%2025l-2%201c-2-1-5%201-5%204%201%201%200%202-1%203-3%201-3%204%200%205%201%201%202%202%201%204%200%202%204%206%205%204h2l2%202c2%201%205%200%205-2h3c1%202%204-2%203-5l1-2c3%200%203-6%200-6v-3c0-3-2-5-5-5h-2c-1-2-6-2-7%200m39%203c-3%202-2%207%202%209%205%202%203%206-2%204-2%200-2%200-2%202%200%203%207%203%209%200l2-2%202%202c1%202%202%202%204%202%204-1%206-4%201-4l-3-1%201-1c2%202%206-1%206-3%201-1%201%200%201%202%200%205%201%207%204%207%202%200%202-1%201-3-3-3-3-7%200-8%202%200%202%200%202%203%200%205%202%208%204%208s3-1%201-3c-3-2-2-6%200-8%201-1%201-1-1-3s-3-2-4%200c-1%201-4%202-4%200s-3-1-3%201c-1%202-1%202-3%200-3-1-8%200-9%203%200%202%200%202-5%200-4-2-4-3-2-4h2c2%201%204-1%203-3h-7m55%204l-2%202a518%20518%200%2000-1%2011c-1%202%201%205%205%205s6-2%206-5c0-1%200-2%201-1h7c2-2%201-6-1-7-3-1-4-3-1-3%202%201%204-1%203-2s-7%200-8%201h-1c-1-1-5-2-8-1M22%20850v19h18c2-1%202-2%202-8l-1-9v-3h-9l-10%201m27%200c-3%202-3%207%202%209%204%202%204%205-1%204-3%200-3%200-3%202%201%204%2011%201%2011-3%200-2-2-5-4-5l-3-2c-2-1%200-3%203-2%203%200%203-2%201-3h-6m55%207c0%207%201%209%202%209s2-2%202-5c0-8%204-7%204%201%201%206%203%205%203-1s-2-8-6-8l-1-2c0-1%200-2-2-2s-2%201-2%208m26-7v2l-3%201c-4%200-5%202-5%208%200%205%202%207%207%205h4v-9c0-8-1-10-3-7m12%201c0%202-1%203-2%203-5%200-6%201-6%205%200%206%203%209%207%208l4-1v-9l-1-8-2%202m-117%201l-1%208v7h16v-6c0-9-1-10-8-10l-7%201m49%202c-3%200-4%205-2%209%203%206%208%205%2011-3%201-1%201-1%201%201%200%206%203%207%205%202l1-3%202%203%202%203c1%201%205-11%204-11-1-2-3-1-3%202l-1%204-1-4c-2-4-4-4-5%201l-1%203-1-4c-1-3-2-4-4-1h-1c0-1-3-3-5-3l-2%201m75%200c-3%202-3%2011%200%2012%203%202%207%201%207-1%200-1-1-2-3-2-4%201-4-2%200-2%203%200%204-1%204-3%200-4-4-6-8-4m45%201c-4%204-1%2012%204%2012%204-1%206-4%201-4l-3-1%202-1c4%201%206-1%204-5-2-3-5-4-8-1M49%20904v15c1%202%206%202%208%200%205-4%200-15-5-12-1%201-1%200-1-1%200-3-1-4-2-2m-32%201v3l3%2010c0%204%203%201%205-3l1-5%202%205c1%206%204%207%205%202l1-3%201-6c1-4%201-4-1-4l-2%204c-1%206-2%206-3%201l-3-5-2%205c-1%204-2%203-3-1-2-3-3-5-4-3m44%207c0%209%200%209%206%208%205-1%207-3%207-8%200-6-2-8-8-8h-5v8m18-6l-3%208c-2%206-2%206%200%206l2-2c1-4%205-4%207-1%201%203%203%204%203%201l-1-4-3-7c-2-4-4-4-5-1m-41%203c-5%205-1%2013%205%2011%204%200%204-2%200-2s-4-3%200-3c4-1%205-3%202-6-2-3-5-3-7%200m20%2048c-2%200-2%201-2%209s1%2011%202%205c1-2%202-2%203-2%205%202%208-8%203-12h-6m269%200c-2%200-3%2010-1%2012l1-3c0-4%202-8%204-7l1%205c0%206%203%205%203%200%201-6%203-6%204-1%201%206%203%206%203%201%200-6-2-7-8-7h-7m-208%2047c0%202%200%202-2%202-3-1-6%202-6%206%200%205%202%207%206%206s5-3%204-11c0-5-2-7-2-3m13%200c-1%202-1%202-3%202-3-1-5%202-5%207l1%205h9v-8c0-8-1-11-2-6m58%204c-3%203-1%2011%203%2011%205%200%208-8%205-12-2-2-6-1-8%201m96-1c-4%206%202%2015%207%2010%202-2%203-8%201-10h-8m-192%2028l-1%208v8h4c6%200%209-5%207-13%200-3-8-5-10-3m-45%201l1%208a212%20212%200%20013%207l2-5c2-6%203-5%205%201%201%204%203%205%203%202l1-4c2-4%203-8%202-9s-3%203-3%206-2%202-4-3c-1-5-3-5-4%200-2%206-3%206-3%201-1-4-2-6-3-4m31%207l1%208h3c4%200%206-1%206-6s-2-7-5-7l-3-1c-1-4-2-1-2%206'%20fill='%23d3d3d3'%20fill-rule='evenodd'/%3e%3c/svg%3e\" style=\"position: absolute;top:0;left:0;width: 100%;height:100%;object-fit: cover;object-position: center;\"><img src=\"/acorns/static/370d092a172378671db39e796b445331/2bad8/1588047143716.jpg\" alt title name=\"images/1588047143716.jpg\" data-src=\"./images/1588047143716.jpg\" class=\"front_image\" loading=\"lazy\" srcSet=\"/acorns/static/370d092a172378671db39e796b445331/2bad8/1588047143716.jpg 224w\" sizes=\"(max-width: 224px) 100vw, 224px\" data-action=\"zoom\" style=\"max-width: 100%;position: absolute;top:0;left:0;width: 100%;height:100%;object-fit: cover;object-position: center;\"></div><br><div class=\"story_image_caption story_image_blank_caption\"></div></div></div><p></p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">但实际实验下来体验很差。在播放大于 2 G 的视频时，加载缓慢，拖动进度条后有大概率卡死，NUC 的 CPU 占用率大幅飙升，不久后 nextcloud 的 3 个 php-handler 进程陷入 D(TASK_UNINTERRUPTIBLE) 状态，简单来说就是卡死了，需要重启进程(容器)。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">虽然我的机器是功耗 15W 的 NUC ，但它也没有菜到这种地步。于是我将锅甩给 —— PHP 是世界上最好的语言。启用 Plan B</p>\n<h2 class=\"xsj_heading_hash xsj_heading xsj_heading_h2\" id=\"plan20b20nginx_3\"><div class=\"xiaoshujiang_element xsj_anchor\">\n  <a name=\"plan20b20nginx_3\" class=\"blank_anchor_name\"></a><a id=\"plan20b20nginx_3\" class=\"blank_anchor_id\"></a><a name=\"plan-b-nginx\" class=\"blank_anchor_name\"></a><a id=\"plan-b-nginx\" class=\"blank_anchor_id\"></a>\n</div>\n<span class=\"xsj_heading_content\">Plan B: nginx</span></h2>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">于是我打起了 nginx 的主意，nginx 挂载电影目录，然后直接作为 WebDAV 服务器提供服务。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">为了让 nginx 能够支持 WebDAV 规范中的 PROPFIND 和 OPTIONS ，我们需要安装模块 <a href=\"https://github.com/arut/nginx-dav-ext-module\" class=\"xsj_link xsj_manu_link\">nginx-dav-ext-module</a> 。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">然后在 configure 时，添加 --with-http_dav_module 和 --add-module=/path/to/nginx-dav-ext-module</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">并使用以下配置文件：</p>\n<div class=\"xiaoshujiang_code_container\"><div class=\"xiaoshujiang_pre\"><div class=\"language-nginx hljs code_linenums xiaoshujiang_code\"><ol start=\"1\" class=\"ol_linenums\" style=\"counter-reset: lines 0;\"><li class=\"li_linenum \" date-linenum=\"1\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">1</span>    <span class=\"hljs-section\">server</span> {<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"2\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">2</span>        <span class=\"hljs-attribute\">listen</span> <span class=\"hljs-number\">443</span> ssl http2;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"3\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">3</span>        <span class=\"hljs-attribute\">server_name</span> yourhostname.com;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"4\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">4</span>        <span class=\"hljs-attribute\">ssl_certificate</span> <span class=\"hljs-string\">\"your cert\"</span>;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"5\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">5</span>        <span class=\"hljs-attribute\">ssl_certificate_key</span> <span class=\"hljs-string\">\"your cert key\"</span>;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"6\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">6</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"7\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">7</span>        <span class=\"hljs-attribute\">client_max_body_size</span> <span class=\"hljs-number\">102400M</span>;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"8\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">8</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"9\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">9</span>        <span class=\"hljs-comment\"># rewrite URL to allow create directory</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"10\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">10</span>        <span class=\"hljs-attribute\">location</span> / {<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"11\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">11</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"12\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">12</span>            <span class=\"hljs-attribute\">set</span> <span class=\"hljs-variable\">$dest</span> <span class=\"hljs-variable\">$http_destination</span>;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"13\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">13</span>            <span class=\"hljs-attribute\">if</span> (-d <span class=\"hljs-variable\">$request_filename</span>) {<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"14\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">14</span>                <span class=\"hljs-attribute\">rewrite</span><span class=\"hljs-regexp\"> ^(.*[^/])$</span> <span class=\"hljs-variable\">$1</span>/;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"15\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">15</span>                <span class=\"hljs-attribute\">set</span> <span class=\"hljs-variable\">$dest</span> <span class=\"hljs-variable\">$dest</span>/;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"16\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">16</span>            }<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"17\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">17</span>            <span class=\"hljs-attribute\">if</span> (<span class=\"hljs-variable\">$request_method</span> <span class=\"hljs-regexp\">~ (MOVE|COPY))</span> {<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"18\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">18</span>                <span class=\"hljs-attribute\">more_set_input_headers</span> <span class=\"hljs-string\">'Destination: <span class=\"hljs-variable\">$dest</span>'</span>;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"19\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">19</span>            }<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"20\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">20</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"21\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">21</span>            <span class=\"hljs-attribute\">if</span> (<span class=\"hljs-variable\">$request_method</span> <span class=\"hljs-regexp\">~ MKCOL)</span> {<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"22\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">22</span>                <span class=\"hljs-attribute\">rewrite</span><span class=\"hljs-regexp\"> ^(.*[^/])$</span> <span class=\"hljs-variable\">$1</span>/ <span class=\"hljs-literal\">break</span>;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"23\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">23</span>            }<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"24\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">24</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"25\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">25</span>            <span class=\"hljs-attribute\">dav_methods</span> PUT DELETE MKCOL COPY MOVE;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"26\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">26</span>            <span class=\"hljs-attribute\">dav_ext_methods</span> PROPFIND OPTIONS;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"27\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">27</span>            <span class=\"hljs-attribute\">dav_access</span> user:rw;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"28\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">28</span>            <span class=\"hljs-attribute\">create_full_put_path</span>  <span class=\"hljs-literal\">on</span>;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"29\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">29</span>            <span class=\"hljs-attribute\">root</span> /webdav;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"30\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">30</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"31\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">31</span>            <span class=\"hljs-attribute\">auth_basic</span> <span class=\"hljs-string\">\"Restricted access\"</span>;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"32\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">32</span>            <span class=\"hljs-attribute\">auth_basic_user_file</span> /etc/nginx/htpasswd.conf;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"33\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">33</span>        }<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"34\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">34</span>    }<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li></ol></div></div></div>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">该配置开启了 HTTPS ，因为 HTTP2 需要开启 SSL。因此需要设置域名的证书和密钥。同时为了保证安全性，还设置了密码认证，密码文件通过 <code>htpasswd</code> 工具生成。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">而：</p>\n<div class=\"xiaoshujiang_code_container\"><div class=\"xiaoshujiang_pre\"><div class=\"language-nginx hljs code_linenums xiaoshujiang_code\"><ol start=\"1\" class=\"ol_linenums\" style=\"counter-reset: lines 0;\"><li class=\"li_linenum \" date-linenum=\"1\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">1</span>            <span class=\"hljs-attribute\">set</span> <span class=\"hljs-variable\">$dest</span> <span class=\"hljs-variable\">$http_destination</span>;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"2\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">2</span>            <span class=\"hljs-attribute\">if</span> (-d <span class=\"hljs-variable\">$request_filename</span>) {<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"3\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">3</span>                <span class=\"hljs-attribute\">rewrite</span><span class=\"hljs-regexp\"> ^(.*[^/])$</span> <span class=\"hljs-variable\">$1</span>/;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"4\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">4</span>                <span class=\"hljs-attribute\">set</span> <span class=\"hljs-variable\">$dest</span> <span class=\"hljs-variable\">$dest</span>/;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"5\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">5</span>            }<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"6\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">6</span>            <span class=\"hljs-attribute\">if</span> (<span class=\"hljs-variable\">$request_method</span> <span class=\"hljs-regexp\">~ (MOVE|COPY))</span> {<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"7\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">7</span>                <span class=\"hljs-attribute\">more_set_input_headers</span> <span class=\"hljs-string\">'Destination: <span class=\"hljs-variable\">$dest</span>'</span>;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"8\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">8</span>            }<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"9\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">9</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"10\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">10</span>            <span class=\"hljs-attribute\">if</span> (<span class=\"hljs-variable\">$request_method</span> <span class=\"hljs-regexp\">~ MKCOL)</span> {<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"11\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">11</span>                <span class=\"hljs-attribute\">rewrite</span><span class=\"hljs-regexp\"> ^(.*[^/])$</span> <span class=\"hljs-variable\">$1</span>/ <span class=\"hljs-literal\">break</span>;<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"12\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">12</span>            }<span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li></ol></div></div></div>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">处理的是某些 WebDAV 客户端(如 OS X 下的 ForkLift) 在 创建文件夹 / 复制文件夹 / 移动文件夹 失败的问题：</p>\n<div class=\"xiaoshujiang_code_container\"><div class=\"xiaoshujiang_pre\"><div class=\"language-bash hljs code_linenums xiaoshujiang_code\"><ol start=\"1\" class=\"ol_linenums\" style=\"counter-reset: lines 0;\"><li class=\"li_linenum \" date-linenum=\"1\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">1</span>2018/06/03 08:03:58 [error] 7<span class=\"hljs-comment\">#7: *1 MKCOL can create a collection only, client: 8.8.8.8, server: yourhostname.com, request: \"MKCOL /sp HTTP/2.0\", host: \"yourhostname.com\"</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"2\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">2</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"3\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">3</span>2018/06/03 08:17:20 [error] 7<span class=\"hljs-comment\">#7: *18 \"/sp\" is collection, client: 8.8.8.8, server: yourhostname.com, request: \"MOVE /sp HTTP/2.0\", host: \"yourhostname.com\"</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li><li class=\"li_linenum \" date-linenum=\"4\"><span class=\"li_linenum_before_span li_linenum_before_span_hide\">4</span><span style=\"user-select:none;display:none;\">&nbsp;</span><br class=\"code_line_break_hack_br\"><hr class=\"code_line_break_hack_hr code_line_break_hack\" style=\"margin:0;border:0;border-top:0;border-bottom:0;\"></li></ol></div></div></div>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">这是因为 nginx 创建的 WebDAV server 要求所有对文件夹的操作，路径结尾都要有斜杠 <code>/</code> 。而某些客户端在对文件夹进行操作时路径结尾没有斜杠 <code>/</code>，于是报错。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">解决方法是 url rewrite，如果操作的是文件夹，则补上 <code>/</code>。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">但对于 MOVE / COPY 操作，文件路径还会设置到 header 的 Destination 中，也需要 rewrite ，这需要借助 <a href=\"https://github.com/openresty/headers-more-nginx-module#more_set_input_headers\" class=\"xsj_link xsj_manu_link\">headers-more-nginx-module</a> 模块。需要在 configure 时，添加 <code>--add-module=/path/to/headers-more-nginx-module</code></p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">修改后的 Dockerfile 可见 <a href=\"https://github.com/binss/docker-nginx-webdav\" class=\"xsj_link xsj_auto_link\">https://github.com/binss/docker-nginx-webdav</a> ，将它和它的 submodule clone 下来后 docker build 即可。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">实测结果令我满意：播放 10G 大小的视频，同局域网下能够在 1 秒内加载和拖动，在教育网同校区内能够在 5 秒内加载和拖动。htop 查看 CPU，发现几乎毫无波动。</p>\n</div>\n\n","excerpt":"根据 wikipedia ：\n个人理解，WebDAV 就是通过 Restful API ，实现对服务端文件的 创建 / 删除 / 读取 / 修改，比起其他文件传输协议，它基于 HTTP，不容易被当作不明流量被砍掉。同时能够利用 HTTP 的各种扩展，比如 HTTPS 提供数据加密...","docType":"posts","slug":"tutorial/build-webdav-server-by-nginx","title":"使用 nginx 搭建 WebDAV 服务器","customCss":"","createDate":"April 28, 2020","updateDate":"April 28, 2020","tags":["文章","转载","技术","nginx","webdav","docker"]}},"pageContext":{"slug":"tutorial/build-webdav-server-by-nginx","prev":{"title":"2020-4-27 十大网站创业方向","docType":"posts","slug":"startup/top-10-website-startup-directions"},"next":{"title":"搭建个人 webdav 服务器","docType":"posts","slug":"tutorial/build-your-own-webdav"},"pluginOptions":{"tagsPath":"/tags/","archivesPath":"/archives/","basePath":"/","commentType":"gitalk"},"basePath":"/"}}}