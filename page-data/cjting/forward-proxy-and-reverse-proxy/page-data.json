{"componentChunkName":"component---node-modules-suziwen-gatsby-theme-sculpting-src-templates-template-blog-post-js","path":"/cjting/forward-proxy-and-reverse-proxy","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://suziwen.github.io/acorns"}},"storyWriterMarkdown":{"id":"c396ff41-4308-5996-beae-57550fc26cb0","html":"\n\n\t<div class=\"preview html_preview xsj_export_zip\"><div style=\"overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; display: none;\"><svg style=\"display: none;\"><defs id=\"MathJax_SVG_glyphs\"/><defs xmlns=\"http://www.w3.org/2000/svg\"><filter xmlns=\"http://www.w3.org/2000/svg\" id=\"dropshadow\" height=\"130%\">      <fegaussianblur in=\"SourceAlpha\" stddeviation=\"3\"/>       <feoffset dx=\"2\" dy=\"2\" result=\"offsetblur\"/>       <femerge>         <femergenode/>        <femergenode in=\"SourceGraphic\"/>       </femerge>    </filter><filter id=\"editing-stripe-bk\" filterunits=\"userSpaceOnUse\" x=\"-100%\" y=\"-100%\" width=\"300%\" height=\"300%\"><feflood flood-color=\"#700f0f\" result=\"flood1\"/><feflood flood-color=\"#fff\" flood-opacity=\"0.5\" result=\"flood2\"/><feimage xlink:href=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAwcHgiIGhlaWdodD0iMTAwMHB4Ij48ZGVmcz48cGF0dGVybiBpZD0icGF0dGVybiIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeD0iMCIgeT0iMCIgd2lkdGg9IjQiIGhlaWdodD0iNCI+PHBhdGggZD0iTSAtNCAtNCBMIDggOCBNIC04IC00IEwgNCA4IE0gLTQgLTggTCA4IDQiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIxIi8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI3BhdHRlcm4pIi8+PC9zdmc+\" x=\"0\" y=\"0\" width=\"2000\" height=\"1000\" result=\"image\"/><fetile in=\"image\" result=\"tile\"/><fecomposite operator=\"in\" in=\"flood1\" in2=\"tile\" result=\"tile2\"/><fegaussianblur in=\"SourceAlpha\" stddeviation=\"10\" result=\"blur\"/><fecomposite operator=\"in\" in=\"tile2\" in2=\"blur\" result=\"cloud\"/><femorphology operator=\"dilate\" radius=\"2\" in=\"SourceAlpha\" result=\"dilate\"/><fecomposite operator=\"in\" in=\"flood2\" in2=\"dilate\" result=\"base\"/><femerge><femergenode in=\"cloud\"/><femergenode in=\"base\"/><femergenode in=\"SourceGraphic\"/></femerge></filter></defs></svg></div><blockquote class=\"markdown_blockquote\">\n<p class=\"xsj_paragraph xsj_paragraph_level_1\"><span class=\"xsj_placeholder_span\"></span>本文为转载文章,如果涉及侵权,请联系 <a href=\"mailto:suziwen1@gmail.com\" class=\"xsj_link xsj_auto_link\">suziwen1@gmail.com</a>,会第一时间删除</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_1\"><span class=\"xsj_placeholder_span\"></span>转载自: <a href=\"https://cjting.me/2018/08/11/forward-proxy-and-reverse-proxy/\" class=\"xsj_link xsj_auto_link\">https://cjting.me/2018/08/11/forward-proxy-and-reverse-proxy/</a></p>\n</blockquote>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\"></p><div class=\"toc mindmap_toc mindmap_container\" data-hash=\"76c6bbafa8f7bd5ed8b696d2ac61588a_mindmap_toc\"><div class=\"xsj_mindmap xsj_mindmap_toc\"><svg id=\"xsj_mindmap_toc_1587196706430\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" class=\"xsj_svg_viewbox\" style=\"max-width:930px;max-height:392px;\" viewbox=\"0 0 930 392\" width=\"100%\" height=\"100%\"><g transform=\"translate(311,218) scale(1)\"><g class=\"markmap-link\" style=\"fill:none;\"><path stroke=\"#ff9900\" stroke-width=\"2\" d=\"M363,0 L368,0 C404,0 399,40.5 435,40.5 L437,40.5\"/><polygon class=\"markmap-link-polygon\" stroke-width=\"0\" transform=\"translate(363, 0)\" points=\"0,-2 5,0 0,2 -5,0\" style=\"fill: white;\"/><g transform=\"translate(435,40.5)\"><path class=\"markmap-node-path\" d=\"M0,0L135,0\" stroke-width=\"2\" stroke=\"#ff9900\"/><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(135, 0)\" points=\"0,-1 5,0 0,1 -5,0\" style=\"fill: rgb(255, 153, 0);\"/></g></g><g class=\"markmap-link\" style=\"fill:none;\"><path stroke=\"#ff9900\" stroke-width=\"2\" d=\"M363,0 L368,0 C404,0 399,-35.5 435,-35.5 L437,-35.5\"/><polygon class=\"markmap-link-polygon\" stroke-width=\"0\" transform=\"translate(363, 0)\" points=\"0,-2 5,0 0,2 -5,0\" style=\"fill: white;\"/><g transform=\"translate(435,-35.5)\"><path class=\"markmap-node-path\" d=\"M0,0L115,0\" stroke-width=\"2\" stroke=\"#ff9900\"/><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(115, 0)\" points=\"0,-1 5,0 0,1 -5,0\" style=\"fill: rgb(255, 153, 0);\"/></g></g><g class=\"markmap-link\" style=\"fill:none;\"><path stroke=\"#dc3912\" stroke-width=\"4\" d=\"M75,-40.5 L80,-40.5 C152,-40.5 147,81 183,81 L185,81\"/><polygon class=\"markmap-link-polygon\" stroke-width=\"0\" transform=\"translate(75, -40.5)\" points=\"0,-3 5,0 0,3 -5,0\" style=\"fill: white;\"/><g transform=\"translate(183,81)\"><path class=\"markmap-node-path\" d=\"M0,0L139,0\" stroke-width=\"4\" stroke=\"#dc3912\"/><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(139, 0)\" points=\"0,-2 5,0 0,2 -5,0\" style=\"fill: rgb(220, 57, 18);\"/></g></g><g class=\"markmap-link\" style=\"fill:none;\"><path stroke=\"#ff9900\" stroke-width=\"4\" d=\"M75,-40.5 L80,-40.5 C152,-40.5 147,0 183,0 L185,0\"/><polygon class=\"markmap-link-polygon\" stroke-width=\"0\" transform=\"translate(75, -40.5)\" points=\"0,-3 5,0 0,3 -5,0\" style=\"fill: white;\"/><g transform=\"translate(183,0)\"><path class=\"markmap-node-path\" d=\"M0,0L179,0\" stroke-width=\"4\" stroke=\"#ff9900\"/><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(179, 0)\" points=\"0,-2 5,0 0,2 -5,0\" style=\"fill: rgb(255, 153, 0);\"/></g></g><g class=\"markmap-link\" style=\"fill:none;\"><path stroke=\"#109618\" stroke-width=\"4\" d=\"M75,-40.5 L80,-40.5 C152,-40.5 147,-81 183,-81 L185,-81\"/><polygon class=\"markmap-link-polygon\" stroke-width=\"0\" transform=\"translate(75, -40.5)\" points=\"0,-3 5,0 0,3 -5,0\" style=\"fill: white;\"/><g transform=\"translate(183,-81)\"><path class=\"markmap-node-path\" d=\"M0,0L79,0\" stroke-width=\"4\" stroke=\"#109618\"/><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(79, 0)\" points=\"0,-2 5,0 0,2 -5,0\" style=\"fill: rgb(16, 150, 24);\"/></g></g><g class=\"markmap-link\" style=\"fill:none;\"><path stroke=\"#3366cc\" stroke-width=\"4\" d=\"M75,-40.5 L80,-40.5 C152,-40.5 147,-162 183,-162 L185,-162\"/><polygon class=\"markmap-link-polygon\" stroke-width=\"0\" transform=\"translate(75, -40.5)\" points=\"0,-3 5,0 0,3 -5,0\" style=\"fill: white;\"/><g transform=\"translate(183,-162)\"><path class=\"markmap-node-path\" d=\"M0,0L79,0\" stroke-width=\"4\" stroke=\"#3366cc\"/><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(79, 0)\" points=\"0,-2 5,0 0,2 -5,0\" style=\"fill: rgb(51, 102, 204);\"/></g></g><g class=\"markmap-node markmap-root-node\" transform=\"translate(-219,-40.5)\"><polygon class=\"markmap-node-polygon\" stroke-width=\"0\" transform=\"translate(293, 0)\" points=\"0,-3 5,0 0,3 -5,0\" style=\"fill: rgb(51, 102, 204);\"/><g transform=\"translate(1, -36)\"><rect class=\"markmap-node-rect\" rx=\"10\" ry=\"10\" height=\"72\" width=\"292\" fill=\"rgb(78, 156, 255)\" stroke=\"#3366cc\" stroke-width=\"1\"/><text class=\"markmap-node-text\" alignment-baseline=\"middle\" x=\"147\" y=\"46\" text-anchor=\"middle\" style=\"font: bolder 30px sans-serif; fill-opacity: 1; fill: rgb(255, 255, 255);\">正向代理与反向代理</text></g></g><g class=\"markmap-node\" transform=\"translate(183,81)\"><a xlink:href=\"#e4b880e4b8aae681b6e4bd9ce589a7e4bba3e79086_6\"><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 20px sans-serif; fill: rgb(220, 57, 18); stroke: white; stroke-width: 2px; cursor: pointer;\">一个恶作剧代理</text><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 20px sans-serif; fill: rgb(220, 57, 18); cursor: pointer;\">一个恶作剧代理</text></a></g><g class=\"markmap-node\" transform=\"translate(183,0)\"><a xlink:href=\"#e9808fe6988ee4bba3e79086e5928ce698bee5bc8fe4bba3e79086_3\"><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 20px sans-serif; fill: rgb(255, 153, 0); stroke: white; stroke-width: 2px; cursor: pointer;\">透明代理和显式代理</text><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 20px sans-serif; fill: rgb(255, 153, 0); cursor: pointer;\">透明代理和显式代理</text></a></g><g class=\"markmap-node\" transform=\"translate(435,40.5)\"><a xlink:href=\"#so_original_dst_5\"><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 15px sans-serif; fill: rgb(255, 153, 0); stroke: white; stroke-width: 2px; cursor: pointer;\">SO_ORIGINAL_DST</text><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 15px sans-serif; fill: rgb(255, 153, 0); cursor: pointer;\">SO_ORIGINAL_DST</text></a></g><g class=\"markmap-node\" transform=\"translate(435,-35.5)\"><a xlink:href=\"#http20connect_4\"><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 15px sans-serif; fill: rgb(255, 153, 0); stroke: white; stroke-width: 2px; cursor: pointer;\">HTTP CONNECT</text><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 15px sans-serif; fill: rgb(255, 153, 0); cursor: pointer;\">HTTP CONNECT</text></a></g><g class=\"markmap-node\" transform=\"translate(183,-81)\"><a xlink:href=\"#e58f8de59091e4bba3e79086_2\"><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 20px sans-serif; fill: rgb(16, 150, 24); stroke: white; stroke-width: 2px; cursor: pointer;\">反向代理</text><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 20px sans-serif; fill: rgb(16, 150, 24); cursor: pointer;\">反向代理</text></a></g><g class=\"markmap-node\" transform=\"translate(183,-162)\"><a xlink:href=\"#e6ada3e59091e4bba3e79086_1\"><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 20px sans-serif; fill: rgb(51, 102, 204); stroke: white; stroke-width: 2px; cursor: pointer;\">正向代理</text><text class=\"markmap-node-text\" y=\"-5\" text-anchor=\"start\" x=\"0\" style=\"fill-opacity: 1; font: 20px sans-serif; fill: rgb(51, 102, 204); cursor: pointer;\">正向代理</text></a></g><g class=\"annotation-group\"><g class=\"annotations\"/></g></g></svg></div></div><p></p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">代理的英文叫做 <em class=\"markdown_em_asterisk\">Proxy</em>，是计算机中的常用软件。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">简单来说，代理的功能犹如它的名字所示：代替某人来处理某事。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">常见的代理分两种，正向代理和反向代理。不管哪种代理，它们都位于客户端和服务器之间，将我们传统的 <code>客户端 &lt;-&gt; 服务器</code> 通信变成了 <code>客户端 &lt;-&gt; 代理 &lt;-&gt; 服务器</code> 通信。</p>\n<!--more-->\n<h2 class=\"xsj_heading_hash xsj_heading xsj_heading_h2\" id=\"e6ada3e59091e4bba3e79086_1\"><div class=\"xiaoshujiang_element xsj_anchor\">\n  <a name=\"e6ada3e59091e4bba3e79086_1\" class=\"blank_anchor_name\"></a><a id=\"e6ada3e59091e4bba3e79086_1\" class=\"blank_anchor_id\"></a><a name=\"正向代理\" class=\"blank_anchor_name\"></a><a id=\"正向代理\" class=\"blank_anchor_id\"></a>\n</div>\n<span class=\"xsj_heading_content\">正向代理</span></h2>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">正向代理用于代理客户端，此时在服务器看来，代理就是客户端，服务器不知道真正客户端的存在。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">一般情况下，代理和客户端位于一个内网中，<code>(客户端 &lt;-&gt; 代理) &lt;-&gt; 服务器</code>。客户端不需要直接将请求发给服务器，而是发给代理，由代理代为请求服务器并返回结果。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">看起来似乎是多了一道手续，没什么好处，但是实际上，正向代理有很多用处：</p>\n<ul class=\"markdown_ul\">\n<li>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>突破限制。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>比如有五台服务器，位于一个内网中，但是只有一台可以访问公网。那么此时通过配置这台服务器作为正向代理，其他四台服务器便也都可以访问公网，这个场景在云服务器中很常见。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>再比如我们的科学上网软件，实际上也是一个正向代理。由于我们的计算机无法直接访问敏感网站，但是代理服务器可以，而我们的计算机访问代理服务器又是没问题的。因此，通过使用代理服务器，我们便可以间接访问到我们感兴趣的网站。</p>\n</li>\n<li>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>流量控制与流量统计。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>由于所有的流量都经过代理，通过配置代理，我们可以对流量进行任意控制。比如，不允许访问淘宝等，很多公司会对员工的网络访问进行限制，便是通过正向代理实现。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>除了控制之外，使用正向代理也可以对流量进行统计。通过解析代理的访问日志，使用一些类似 <a href=\"https://github.com/eldy/awstats\" class=\"xsj_link xsj_manu_link\">awstats</a> 的工具，便可以得到流量的详细统计信息。</p>\n</li>\n<li>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>提升性能。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>正向代理可以缓存经常被访问的网站，从而大幅提升访问速度。</p>\n</li>\n</ul>\n<h2 class=\"xsj_heading_hash xsj_heading xsj_heading_h2\" id=\"e58f8de59091e4bba3e79086_2\"><div class=\"xiaoshujiang_element xsj_anchor\">\n  <a name=\"e58f8de59091e4bba3e79086_2\" class=\"blank_anchor_name\"></a><a id=\"e58f8de59091e4bba3e79086_2\" class=\"blank_anchor_id\"></a><a name=\"反向代理\" class=\"blank_anchor_name\"></a><a id=\"反向代理\" class=\"blank_anchor_id\"></a>\n</div>\n<span class=\"xsj_heading_content\">反向代理</span></h2>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">反向代理用于代理服务器，此时在客户端看来，代理就是服务器，客户端不知道真正服务器的存在。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">一般情况下，代理和服务器位于一个内网中，<code>客户端 &lt;-&gt; (代理 &lt;-&gt; 服务器)</code>。服务器不需要直接和客户端沟通，而是通过代理，由代理接收客户端的请求，再发送给服务器。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">反向代理有如下几个用处：</p>\n<ul class=\"markdown_ul\">\n<li>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>突破限制。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>比如内网中的某个服务器，如果想要在公网访问，我们可以配置内网中拥有公网IP的机器作为反向代理，从而实现对内网服务的访问。</p>\n</li>\n<li>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>负载均衡。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>我们可以部署多台服务器，配置代理将请求转发给不同的服务器。这里有很多算法可以使用，比如最简单的轮流转发 (Round Robin)。这样，当负载增大的时候，客户端无需做任何修改，服务端通过简单的增加服务器便可以应对。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>负载均衡的另一个好处是可以实现容灾容错。如果某台服务器宕机了，代理服务器会将请求转发到其他服务器上，客户端不会受到任何影响。</p>\n</li>\n<li>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>访问加速。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_2\"><span class=\"xsj_placeholder_span\"></span>对于某些大型服务，他们的服务器遍布各地，通过使用反向代理，当请求到来时，代理可以将请求转发给最近的服务器，从而让用户在最短时间内获得响应，这一点其实和 CDN 的工作方式是一样的。</p>\n</li>\n</ul>\n<h2 class=\"xsj_heading_hash xsj_heading xsj_heading_h2\" id=\"e9808fe6988ee4bba3e79086e5928ce698bee5bc8fe4bba3e79086_3\"><div class=\"xiaoshujiang_element xsj_anchor\">\n  <a name=\"e9808fe6988ee4bba3e79086e5928ce698bee5bc8fe4bba3e79086_3\" class=\"blank_anchor_name\"></a><a id=\"e9808fe6988ee4bba3e79086e5928ce698bee5bc8fe4bba3e79086_3\" class=\"blank_anchor_id\"></a><a name=\"透明代理和显式代理\" class=\"blank_anchor_name\"></a><a id=\"透明代理和显式代理\" class=\"blank_anchor_id\"></a>\n</div>\n<span class=\"xsj_heading_content\">透明代理和显式代理</span></h2>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\"><em class=\"markdown_em_asterisk\">透明代理</em> 这个概念只有正向代理才有，因为所有的反向代理在客户端看来都是透明的，客户端不知道请求对象是反向代理还是真正的服务器。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">当使用正向代理的时候，有两种方式：</p>\n<ol class=\"markdown_ol\">\n<li><span class=\"xsj_placeholder_span\"></span>客户端显式配置使用代理，此时客户端知道正向代理的存在，所以是显式代理</li>\n<li><span class=\"xsj_placeholder_span\"></span>客户端没有进行任何配置，但所有流量还是经过了代理，因为客户端不知道代理的存在，所以是透明代理</li>\n</ol>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">很多软件都提供设置代理选项，比如 Chrome，当我们在设置完代理以后，Chrome 就会使用代理进行通信，此时是显式代理。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">设置代理的时候需要设置代理协议，常见的代理协议有 <code>http</code>，<code>https</code>，<code>socks4</code>，<code>socks5</code>。</p>\n<h3 class=\"xsj_heading_hash xsj_heading xsj_heading_h3\" id=\"http20connect_4\"><div class=\"xiaoshujiang_element xsj_anchor\">\n  <a name=\"http20connect_4\" class=\"blank_anchor_name\"></a><a id=\"http20connect_4\" class=\"blank_anchor_id\"></a><a name=\"http-connect\" class=\"blank_anchor_name\"></a><a id=\"http-connect\" class=\"blank_anchor_id\"></a>\n</div>\n<span class=\"xsj_heading_content\">HTTP CONNECT</span></h3>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">之前我一直有个误解，认为使用 HTTP 协议是无法代理 HTTPS 流量的，其实不然。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">HTTP 有一个 <code>CONNECT</code> 方法，可以创建一条 HTTP 隧道，用来转发任意的 TCP 流量。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">通过使用 CONNECT 方法，HTTP 协议可以代理任意的基于 TCP 的协议，当然也包括 HTTPS。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">假设我们配置 Chrome 使用一个 HTTP 代理，当 Chrome 遇到 HTTP 请求时，直接转发给代理，不做任何处理。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">当遇到 HTTPS 请求时，Chrome 会首先使用 CONNECT 方法请求代理，请求中含有目标地址的的域名和端口，代理收到以后，会创建一条到目标地址的 TCP 链接，创建成功以后，返回 <code>200 Connection established</code> 给 Chrome。之后，Chrome 会将 HTTPS 数据包发给代理，而代理会原封不动的发给目标地址，代理此时就像隧道一样，沟通目标地址和客户端。</p>\n<h3 class=\"xsj_heading_hash xsj_heading xsj_heading_h3\" id=\"so_original_dst_5\"><div class=\"xiaoshujiang_element xsj_anchor\">\n  <a name=\"so_original_dst_5\" class=\"blank_anchor_name\"></a><a id=\"so_original_dst_5\" class=\"blank_anchor_id\"></a><a name=\"so_original_dst\" class=\"blank_anchor_name\"></a><a id=\"so_original_dst\" class=\"blank_anchor_id\"></a>\n</div>\n<span class=\"xsj_heading_content\">SO_ORIGINAL_DST</span></h3>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">显式代理必须要手动配置，如果有很多客户端的话就很不方便。这个时候，我们可以使用透明代理技术。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">通过在路由器层将数据包直接转发给代理软件，实现客户端无需配置，但是仍然使用代理来访问网络。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">这个时候有一个问题，即代理如何知道数据包的原始目标地址？</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">假设我们访问百度，浏览器构建一个 HTTP 数据包，目标地址为百度 IP 和 80 端口，经过路由器的时候，路由器转发给到了代理，此时，数据包的目标地址被修改为代理 IP 和代理端口。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">当代理收到数据包以后，如何知道数据包下一步该发送给谁呢？</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">这个问题目前我不知道确切的答案，网上有两种说法：</p>\n<ol class=\"markdown_ol\">\n<li><span class=\"xsj_placeholder_span\"></span>因为 HTTP/1.1 要求所有的请求必须包含 <code>HOST</code> 头，代理可以通过解析 HOST 得到目标地址</li>\n<li><span class=\"xsj_placeholder_span\"></span>通过使用 <code>SO_ORIGINAL_DST</code> 选项获取数据包原始地址</li>\n</ol>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">暂时没有空去验证这个问题，这个问题的准确答案留待以后进一步明确。</p>\n<h2 class=\"xsj_heading_hash xsj_heading xsj_heading_h2\" id=\"e4b880e4b8aae681b6e4bd9ce589a7e4bba3e79086_6\"><div class=\"xiaoshujiang_element xsj_anchor\">\n  <a name=\"e4b880e4b8aae681b6e4bd9ce589a7e4bba3e79086_6\" class=\"blank_anchor_name\"></a><a id=\"e4b880e4b8aae681b6e4bd9ce589a7e4bba3e79086_6\" class=\"blank_anchor_id\"></a><a name=\"一个恶作剧代理\" class=\"blank_anchor_name\"></a><a id=\"一个恶作剧代理\" class=\"blank_anchor_id\"></a>\n</div>\n<span class=\"xsj_heading_content\">一个恶作剧代理</span></h2>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">最后，我们使用 <a href=\"http://www.squid-cache.org/\" class=\"xsj_link xsj_manu_link\">Squid</a> 来搭建一个恶作剧代理，这个代理会将所有的图片翻转过来。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">Squid 是一个很常用的正向代理软件，可以用来做访问控制，网站缓存等等。这里我们使用 Squid 的 <em class=\"markdown_em_asterisk\">URL Rewrite</em> 功能，对于所有的图片请求，将图片下载到本地，然后调用 <code>mogrify</code> 翻转图片，最后将翻转以后的图片返回给客户端。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">这样做的效果就是，当你上网浏览时，所有的图片都是倒过来的😉，效果如下：</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\"></p><div class=\"story_image_container story_block_image\"><div class=\"story_image\"><div class=\"gatsby-wrapper-image\" style=\"display:inline-block;max-width: 100%;width:1024px; margin-left: auto; margin-right: auto;position:relative;\"><div style=\"width:100%;display:block;padding-bottom: 45.3125%;\"></div><img class=\"background_image\" src=\"data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='400'%20height='181'%20viewBox='0%200%20400%20181'%20preserveAspectRatio='none'%3e%3cpath%20d='M137%204c-1%204%200%205%2010%205h10V2h-10c-6%200-9%201-10%202M1%2030l1%205%201%208v5l-1-1c-2%200%200%2011%203%2017l1%206%201%203c1%202%202%203%208%203%2011%201%2011%201%208-4-2-3-3-7-3-11l-1-5c-1%202-3%203-3%200l2-2c2%200%207-9%206-12l1-7c1-6%201-6-5-4-6%203-11%202-14-2-3-3-5-3-5%201m32-1l-1%205c0%204%201%204%203%204%207-1%2010%203%2014%2015%203%207%203%209-1%209-4%201-5%203-1%204l3%201h-4c-3%200-3%200-2%201l4%202c2%200%202%201%202%203%200%203%200%204%202%204%203%200%204-3%205-14%201-25%201-26-2-31l-2-5H43c-9%200-10%200-10%202m27%2022v25h32c16-1%2018-2%2020-10%201-7%201-8%204-9l3-3c0-3%200-4%208-12%203-4%207-7%208-7%202%200%202-1%202-4%200-4%200-4-4-4-3%200-4%200-4%202l-3%202c-2%200-2%200-1%201v1h-6l-2%201h4l-2%201c-2%200-3%202-5%203l-3%202-2%201-1-1-2-2%201%203%201%207-1%204v-5l-1-4-2-1-8-5-8-5c-1-1-1-1-1%201s0%203-1%202l-1-4c1-3%201-3-4-3l-13-1h-8v24m95-23l3%203%203%202c1%201%203%202%204%201l1%201-2%201v10l-1%203c-3%205%202%2021%208%2024%203%202%209%203%209%202l1-1%208-4%202-3c2-2%205-10%204-13s-3-4-3-1h-1l-1-4v2l-1%203-1%205c0%2011-10%2017-14%208-2-3-2-4%200-4l1-1h-1l-2-1c-1-1%200-1%201-1l2-1-2-2c-3%200-4-1-3-7%201-4%202-6%205-8%203-3%204-4%201-4l-5-3-2-3c2%200%201-2-3-3-4-2-11-3-11-1m148%203l-2%204-1-4c0-3-2-4-4-2l-1%201-1%203c-1%204-3%207-5%206s-1-6%201-7c1%200%202-4%200-4s-3%203-4%208c-1%207%200%208%2011%208%207%200%209-1%207-2-2-2%200-8%202-11%202-2%204-3%206-1s1%2010-1%2010l-4%203%203%201c3%200%203%200%202%202l-3%201%202%203c3%203%204%206%201%205v5h5l-1%203-2%201-2-1h-6l-1%201h5c2%200%204%207%202%208l-1%205c2%200%204-3%204-6%200-1%200-2%201-1l1%201c-1%204%200%205%203%205s3%200%203-3c0-2%200-2-2-1-1%201-1%201-1-4v-6c-1-1-1-1%201-1s2-1%202-3l-2-2c-1%201-1%200-1-2s0-3-1-2c-2%200-2-1-1-3v-1l-1-2-1-2v-3c2-10%201-14-6-14-4%200-5%200-7%204m26-3c-2%200-2%201-1%204%200%205-1%209-3%209-1%201-1%201%201%202l2%202-1%202-5-1c-1-2-2%200-2%202%201%202%201%202%202%201l5-1c2%200%202%200%202-2s1-3%202-3c2%200%202-1%202-8%200-8%200-8-4-7M93%2043c-3%202-2%202%200%202%201-1%203%200%204%201l3%202h-5c-3%200-4%200-4-2-1-1-1-1-2%202-3%204-2%206%201%207l2%202c-1%202%203%201%204%200l4-2c3%200%203%200%201-7-1-6-5-9-8-5m258%205v5l-1-4-2-3v2c0%203%200%203-1%201-2-1-2-1-2%201l-1-1-1-2v2l5%209%204%208%201%202%203%202c1%203%206%206%2012%206%204%200%205%200%204-1s0-2%202-2c5-1%207-10%204-13-3-2-4-2-2%201%203%203%202%205%200%206-3%201-6%200-6-2h-1c-1%203-5%200-7-5-3-4-5-5-6-1-1%203-3-4-3-10l-1-5-1%204M83%20103v25h10c4%200%205%200%203-2l-1-3c1-1%200-2-1-2-3-1-3-9%200-9%207-2%2010%200%2010%204%200%202%200%203-2%203s-3%201-2%204h1c0-2%202-3%202%200l-1%203c-2%202-2%202%201%202%204%201%207-1%208-3%200-2%201-2%202-1%202%202%202-2%203-15l1-19c2-13%203-12-17-12H83v25m159-16l1%2011c2%201%202%202%200%204-1%202-1%2016%201%2017l1%204c0%204%201%205%2010%205%2011%200%2012%200%209-1s-5-7-4-9v-2l-1-2-3-2c-3-2-4-5%200-8l1-3h7c3-1%203-1%201-1-3%200-4-2-2-2l-1-1-2-1%202-1c4-1%208-6%206-7-1%200-2-1-1-2%200-2-1-1-4%201-5%203-14%200-11-4%201-3-1-5-6-5h-4v9m49-7l-1%201-1-1h-2l-2%201-1%201-2%201%207%201%206%201h11c1%202%208%202%207%201l1-1%201-4v-3h-12c-11%200-13%200-12%202m-109%200l2%201h1l1%201c1%200%203%201%203%203l1%203%201%203c3%202%203%203%203%209%200%2010%202%2018%207%2022l3%204c-1%201%202%201%205%201%2012%200%2018-8%2019-26%200-10%200-10%203-10%204-1%2010-7%2010-10v-2h-30c-21%200-30%200-29%201M1%20103v23h81V80H1v23m315%200v23h46l4-7c3-7%204-8%204-16s0-9%202-12c3-3%204-3%205%201%202%205%203%207%205%207s4-6%204-11l2-5c2-3%200-3-17-3h-55v23M207%2088c-8%207-10%2017-6%2024%202%204%204%205%205%202%201-1%200-2-1-3-2-1-2-16%200-19h2c0%202%203%200%204-3%200-4%200-4-4-1M51%2093l-3%206-2%206c-1%203-1%203%203%207l5%207c2%205%207%205%209%201%201-2%201-3-1-4-2%200-2%200-1-1%202%200%202%200%201-2-1-1%200-1%203-1%202%200%202-4%201-6h-5v-3c-2%200-2%200-1-1v-2l2-1c2%201%202%201%202-1l-1-2-3-1-3-4c0-3-3-2-6%202m294%203c-5%205-6%208-3%2011s2%205-1%206c-4%200-4%204-1%207%204%206%207%205%2017-5%203-4%207-6%207-6%202%200%202-3%201-5-2-1-4-7-4-8s-4-3-8-3c-3-1-4-1-8%203m-77-1l2%203c7%209%207%2023%200%2028l-2%202h12v-14c0-15%200-17-4-17l-3-1c-1-2-5-3-5-1m30%206l1%201v2c-2%200-1%202%201%204l2%206c1%205%205%208%208%205%202-2%201-4-1-7-2-1-3-3-3-6%200-5-1-7-4-5h-2l-1-1-1%201m-182%2029c-2%200-2%202-2%2025v25h39v-44l-4%204c-6%205-7%208-8%2018%200%208-2%2015-6%2018s-12-3-9-7v-2c2%200%201-2-1-3-3-1-4-5-2-5h6l-2-1-1-1c1-1%202-2%201-3l-1-1c-1%200-2-1-1-3s6-2%2010-1c2%201%202%201%200-1-3-2-3-3-2-5l1-5v-3c2-3%200-5-6-5h-12m40%200c-2%200-2%202-2%2025v25h10c13%200%2014-1%2014-7%201-5%202-6%202-3%202%206%203%203%203-5a4562%204562%200%20010-29l-1-6h-9a134%20134%200%2001-17%200m-144%201c2%200%202%201%201%206l-1%206v2l-1%202-3%202H7l-1-2c-1-1-1%204-1%2012%200%2013%200%2013%201%209l2-5v4l3%208%202%205h19l2-9c3-15%205-16%208-8%202%205%204%207%207%206%202%200%202-1%202-9v-9l-5%201-6-1-4-4c-3-4-3-4-5-2s-2%202-4-1l-1-5-1-5-1-4h-7c-4%200-6%200-5%201m71%2024v25h3c2%200%202%200%202-7v-25l1-18h-6v25m17-24l1%201c-2%200-2%200-1%201%202%200%200%202-2%202s-2%201-2%202l2%205%202%205v1l-2%201%202%201h1l-3%201c-2%200-2%201-1%204%201%207%201%208%204%209l3%201h-3c-2%200-3%200-2%201%203%200%202%203-1%202-2%200-2%200-2%203l1%205c1%204%202%204%209%204h7v-7l-1-8v-33c0-2-2-2-7-2s-7%200-5%201m143%200l1%201v1c-1%202-1%204%202%204l4%208%202%207h-5c-3%200-4%200-3%201v6c-2%200-1%203%201%203s4%203%205%209c1%207%202%208%2013%208h10l1-4%201-8v-26c0-10-1-14-2-9h-1l-2-2c-2%200-3%200-2%202%200%202%200%202-1%201l-2%201%204%201c3%200%204%203%202%205v4l1%201c1%200%201%205-1%206-2%202-4-1-4-5-1-3-1-4-3-4-3%200-3-11%200-11%201-1-4-1-10-1l-11%201m60%202v5c-2%201-2%201-2-2l-1%205c-1%209%200%2029%202%2031%205%206%208%208%2016%208s11-2%2017-8c3-4%206-11%205-14l1-2v-6l-2-4c-2-7-6-8-6-1%200%202%201%203%203%204%204%202%203%207-1%206-2%200-2%200-1%201l1%202v4c1%203-1%206-4%205-2%200-2%200-1%202l-1%202-1%201c-1%203-5%205-8%205-6-2-8-13-4-20l1-3h-8l7-4%2011-3%202-2h-1c-3%200-3-2%200-3%202-2%203-2%203-1%201%201%201%200%201-1%200-3%200-3-3-3s-8-2-11-4c-1-2-4-2-9-3h-7l1%203m55-1l-1%201c-3%200%200%2011%203%2012%203%202%207%204%205%204l-1%206v10c0%205%203%2012%206%2013%204%203%2014%202%2014-2l1-2c2%200%204-6%204-10l3-2%202-1h-5c-2%201-3%200-4-1-1-2-1-2-1%200%201%204%200%207-2%206l-3%201%202%201c3-1%203-1%202%202-1%207-7%209-10%205-2-3-2-7-1-7l1-1-2-1c-3%200-2-7%202-12l2-3c-2%200-6-3-6-5l-2-1c-2-1-3-4-3-8%201-2-3-7-5-7l-1%202m-292%201l2%203c2%201%203%202%200%205-2%203-4%202-5-1l-1-2-3%201c-3%201-3%201-3-2%200-2-1-2-1%200l-1%203v2l1%202c0%202%200%202%201%200%200-2%201-3%204-3l3%201c-2%202%203%204%208%204l11-1-3-2c-3%200-3-1-3-4%200-4-4-8-5-6h-2c-1-3-3-2-3%200m152%2013c1%207%202%208%2010%208s9-1%209-9v-3l-2%203c-3%205-8%205-12%201l-3-4-1-1-1%205m-152%204l1%202c2%200%203%203%202%204l-1%202-2%202-2-2c-1-1-1-1-1%201%200%204%201%204%2011%204l8-1-4-2c-3-1-4-4-2-6%201-2-4-6-5-4h-2c-1-3-3-2-3%200m197%207l-1%206c0%205%200%205%202%205s2%200%202%202c0%206%204%209%206%205v-5c-1-2-2-3-1-4l1-3c0-2-1-2-4-2h-4l2-2%201-2h-4M66%20167l2%202h1l1%202-1%202-1%201c0%202-2%203-3%202-2-2-3%200-1%202%202%203%2018%203%2018%201%200-1-1-2-3-2-3%200-3-1-3-4%200-6-4-9-5-6h-2c-1-3-3-2-3%200m146%200v2l-2%205c-2%205-9%204-14-2l-3-3v3c2%207%203%208%2012%208h9v-6c0-4-2-11-2-7'%20fill='%23d3d3d3'%20fill-rule='evenodd'/%3e%3c/svg%3e\" style=\"position: absolute;top:0;left:0;width: 100%;height:100%;object-fit: cover;object-position: center;\"><img src=\"/acorns/static/a3acc59dd8dc2628d382d88f3bdec4b8/72e01/1586493155813.jpg\" alt title name=\"images/1586493155813.jpg\" data-src=\"./images/1586493155813.jpg\" class=\"front_image\" loading=\"lazy\" srcSet=\"/acorns/static/a3acc59dd8dc2628d382d88f3bdec4b8/e4a55/1586493155813.jpg 256w,\n/acorns/static/a3acc59dd8dc2628d382d88f3bdec4b8/36dd4/1586493155813.jpg 512w,\n/acorns/static/a3acc59dd8dc2628d382d88f3bdec4b8/72e01/1586493155813.jpg 1024w,\n/acorns/static/a3acc59dd8dc2628d382d88f3bdec4b8/ac99c/1586493155813.jpg 1536w,\n/acorns/static/a3acc59dd8dc2628d382d88f3bdec4b8/d8d09/1586493155813.jpg 1916w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" data-action=\"zoom\" style=\"max-width: 100%;position: absolute;top:0;left:0;width: 100%;height:100%;object-fit: cover;object-position: center;\"></div><br><div class=\"story_image_caption story_image_blank_caption\"></div></div></div><p></p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">想象这样一个场景：在一个阳光明媚的午后，你发现你的邻居在蹭你的网，你并没有选择修改密码，而是默默地启动这个恶作剧代理，配置你的路由器，使用 iptables 将蹭网流量转发到这个代理。于此同时，你的邻居发现，前一刻还十分精彩的互联网世界，突然颠倒了，他苦苦思索，他不知所措，他深深地被这个世界的恶意所伤害。</p>\n<p class=\"xsj_paragraph xsj_paragraph_level_0\">关于恶作剧代理的具体代码可以去 GitHub 仓库 <a href=\"https://github.com/cj1128/squid-trick-proxy-demo\" class=\"xsj_link xsj_manu_link\">squid-trick-proxy-demo</a> 上查看。</p>\n</div>\n\n","excerpt":"代理的英文叫做 Proxy，是计算机中的常用软件。\n简单来说，代理的功能犹如它的名字所示：代替某人来处理某事。\n常见的代理分两种，正向代理和反向代理。不管哪种代理，它们都位于客户端和服务器之间，将我们传统的 客户端 &lt;-&gt; 服务器 通信变成了 客户端 &lt;-&gt...","docType":"posts","slug":"cjting/forward-proxy-and-reverse-proxy","title":"正向代理与反向代理","customCss":"","createDate":"April 10, 2020","updateDate":"April 18, 2020","tags":["文章","转载","技术","代理"]}},"pageContext":{"slug":"cjting/forward-proxy-and-reverse-proxy","prev":{"title":"从图片优化说起","docType":"posts","slug":"cjting/image-optimization"},"next":{"title":"关于字符编码","docType":"posts","slug":"cjting/about-string-encoding"},"pluginOptions":{"tagsPath":"/tags/","archivesPath":"/archives/","basePath":"/","commentType":"gitalk"},"basePath":"/"}}}